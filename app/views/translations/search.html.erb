<div class="home-container">
  <div class="search-header-section">
    <div class="search-top-bar">
      <div class="user-dropdown">
        <div class="user-action-btn" onclick="document.getElementById('user-menu').classList.toggle('show')">
          <i class="fa-solid fa-user"></i>
        </div>
        <div id="user-menu" class="dropdown-content">
          <% if user_signed_in? %>
            <p class="user-email"><%= current_user.email %></p>
            <%= button_to t('nav.logout'), destroy_user_session_path, method: :delete %>
          <% else %>
            <%= link_to t('nav.login'), new_user_session_path %>
            <%= link_to t('nav.sign_up'), new_user_registration_path %>
          <% end %>
        </div>
      </div>
    </div>

    <div class="search-logo-container">
      <%= link_to root_path do %>
        <%= image_tag "logo.png", alt: "idiomary logo", class: "search-logo-small" %>
      <% end %>
    </div>

    <div class="search-main-nav">
      <%= link_to my_dictionary_path, class: "nav-item" do %>
        <i class="fa-regular fa-bookmark"></i>
        <span>Saved</span>
      <% end %>
      <%= link_to root_path, class: "nav-item active" do %>
        <i class="fa-solid fa-house"></i>
        <span>Home</span>
      <% end %>
      <a href="#" class="nav-item">
        <i class="fa-solid fa-gear"></i>
        <span>Settings</span>
      </a>
    </div>
  </div>

  <div class="home-map-section search-map-style">
    <div class="map-overlay-content">

      <%= form_with url: search_path, method: :post, data: { turbo: false }, class: "search-box-container" do |f| %>
        <div class="search-input-wrapper">
          <%= f.text_field :idiom, placeholder: "Cerca un modo di dire...", class: "search-input-field", value: @idiom %>
          <button type="submit" class="search-icon-submit">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </div>

<div class="language-selector-row">
  <div class="lang-pill">
    <span class="flag-mini" id="flag-source">
      <%= @source_lang == 'en' ? "ğŸ‡¬ğŸ‡§" : (@source_lang == 'fr' ? "ğŸ‡«ğŸ‡·" : (@source_lang == 'es' ? "ğŸ‡ªğŸ‡¸" : (@source_lang == 'pt' ? "ğŸ‡µğŸ‡¹" : "ğŸ‡®ğŸ‡¹"))) %>
    </span>
    <%= f.select :source_lang, [['Italiano', 'it'], ['English', 'en'], ['FranÃ§ais', 'fr'], ['Spanish', 'es'], ['Portuguese', 'pt']],
        { selected: @source_lang },
        { onchange: "updateFlag(this, 'source')" } %>
  </div>

  <i class="fa-solid fa-arrow-right"></i>

  <div class="lang-pill">
    <span class="flag-mini" id="flag-target">
      <%= @target_lang == 'en' ? "ğŸ‡¬ğŸ‡§" : (@target_lang == 'it' ? "ğŸ‡®ğŸ‡¹" : (@target_lang == 'es' ? "ğŸ‡ªğŸ‡¸" : (@target_lang == 'pt' ? "ğŸ‡µğŸ‡¹" : "ğŸ‡«ğŸ‡·"))) %>
    </span>
    <%= f.select :target_lang, [['FranÃ§ais', 'fr'], ['Italiano', 'it'], ['English', 'en'], ['Spanish', 'es'], ['Portuguese', 'pt']],
        { selected: @target_lang },
        { onchange: "updateFlag(this, 'target')" } %>
  </div>
</div>

        <%= f.submit "translate", class: "btn-translate-blue" %>
      <% end %>

<% if @result.present? %>
  <div class="result-display-card">
    <h2 class="result-title">â€œ<%= @idiom %>â€</h2>

    <div class="result-content">
      <%= simple_format(@result) %>
    </div>

    <div class="result-actions">
      <% if user_signed_in? %>
        <%= button_to save_translation_path, method: :post, params: {
          original_idiom: @idiom,
          source_language: @source_lang,
          target_language: @target_lang,
          ai_response: @result
        }, class: "btn-save-green" do %>
          <i class="fa-solid fa-bookmark" style="margin-right: 8px;"></i> Salva scheda
        <% end %>
      <% else %>
        <div class="login-invitation">
          <p><%= t('result.signup_prompt_text', default: "Vuoi salvare questo modo di dire?") %></p>
          <%= link_to new_user_registration_path, class: "btn-save-green btn-signup-alt" do %>
             Registrati per salvare
          <% end %>
          <p class="small-login-link">
            Hai giÃ  un account? <%= link_to "Accedi", new_user_session_path %>
          </p>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

    </div>
  </div>
</div>

<script>
  function updateFlag(selectElement, type) {
    const flags = {
      'it': 'ğŸ‡®ğŸ‡¹',
      'en': 'ğŸ‡¬ğŸ‡§',
      'fr': 'ğŸ‡«ğŸ‡·',
      'es': 'ğŸ‡ªğŸ‡¸',
      'pt': 'ğŸ‡µğŸ‡¹'
    };

    const selectedValue = selectElement.value;
    const flagSpan = document.getElementById('flag-' + type);

    if (flagSpan && flags[selectedValue]) {
      flagSpan.innerText = flags[selectedValue];
    }
  }

  document.addEventListener("turbo:load", function() {
    const sourceSelect = document.querySelector('select[name="source_lang"]');
    const targetSelect = document.querySelector('select[name="target_lang"]');

    if (sourceSelect) updateFlag(sourceSelect, 'source');
    if (targetSelect) updateFlag(targetSelect, 'target');
  });
</script>
