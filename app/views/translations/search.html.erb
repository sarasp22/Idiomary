<div class="home-container">
  <div class="search-header-section">
    <div class="language-dropdown">
      <div class="flag-indicator" onclick="document.getElementById('lang-menu').classList.toggle('show')">
        <%= I18n.locale == :en ? "ðŸ‡¬ðŸ‡§" : (I18n.locale == :it ? "ðŸ‡®ðŸ‡¹" : (I18n.locale == :fr ? "ðŸ‡«ðŸ‡·" : (I18n.locale == :es ? "ðŸ‡ªðŸ‡¸" : "ðŸ‡µðŸ‡¹"))) %>
        <span class="arrow-down">â–¼</span>
      </div>

      <div id="lang-menu" class="dropdown-content">
        <%= link_to "ðŸ‡¬ðŸ‡§ English", url_for(locale: :en) unless I18n.locale == :en %>
        <%= link_to "ðŸ‡®ðŸ‡¹ Italiano", url_for(locale: :it) unless I18n.locale == :it %>
        <%= link_to "ðŸ‡«ðŸ‡· FranÃ§ais", url_for(locale: :fr) unless I18n.locale == :fr %>
        <%= link_to "ðŸ‡ªðŸ‡¸ EspaÃ±ol", url_for(locale: :es) unless I18n.locale == :es %>
        <%= link_to "ðŸ‡µðŸ‡¹ PortuguÃªs", url_for(locale: :pt) unless I18n.locale == :pt %>
      </div>
    </div>

    <div class="user-dropdown">
      <div class="user-action-btn" onclick="document.getElementById('user-menu').classList.toggle('show')">
        <i class="fa-solid fa-user"></i>
      </div>
      <div id="user-menu" class="dropdown-content dropdown-user">
        <% if user_signed_in? %>
          <p class="user-email"><%= current_user.email %></p>
          <%= button_to t('nav.logout'), destroy_user_session_path, method: :delete %>
        <% else %>
          <%= link_to t('nav.login'), new_user_session_path %>
          <%= link_to t('nav.sign_up'), new_user_registration_path %>
        <% end %>
      </div>
    </div>

    <div class="search-logo-container">
      <%= link_to root_path do %>
        <%= image_tag "logo.png", alt: "idiomary logo", class: "search-logo-small" %>
      <% end %>
    </div>


<div class="search-main-nav">
  <%= link_to my_dictionary_path, class: "nav-item" do %>
    <i class="fa-regular fa-bookmark"></i>
    <span><%= t('nav.saved', default: 'Saved') %></span>
  <% end %>

  <%= link_to search_path, class: "nav-item active" do %>
    <i class="fa-solid fa-house"></i>
    <span><%= t('nav.home', default: 'Home') %></span>
  <% end %>

  <%= link_to settings_path, class: "nav-item" do %>
    <i class="fa-solid fa-gear"></i>
    <span><%= t('nav.settings', default: 'Settings') %></span>
  <% end %>
</div>

  </div>

  <div class="home-map-section search-map-style">
    <div class="map-overlay-content">

      <%= form_with url: search_path, method: :post, data: { turbo: false }, class: "search-box-container" do |f| %>
        <div class="search-input-wrapper">
          <%= f.text_field :idiom, placeholder: t('search.placeholder', default: 'Cerca un modo di dire...'), class: "search-input-field", value: @idiom %>
          <button type="submit" class="search-icon-submit">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </div>

        <div class="language-selector-row">
          <div class="lang-pill">
            <span class="flag-mini" id="flag-source">
              <%= @source_lang == 'en' ? "ðŸ‡¬ðŸ‡§" : (@source_lang == 'fr' ? "ðŸ‡«ðŸ‡·" : (@source_lang == 'es' ? "ðŸ‡ªðŸ‡¸" : (@source_lang == 'pt' ? "ðŸ‡µðŸ‡¹" : "ðŸ‡®ðŸ‡¹"))) %>
            </span>
            <%= f.select :source_lang, [
              ['Italiano', 'it'],
              ['English', 'en'],
              ['FranÃ§ais', 'fr'],
              ['EspaÃ±ol', 'es'],
              ['PortuguÃªs', 'pt']
            ], { selected: @source_lang }, { onchange: "updateFlag(this, 'source')" } %>
          </div>

          <i class="fa-solid fa-arrow-right"></i>

          <div class="lang-pill">
            <span class="flag-mini" id="flag-target">
              <%= @target_lang == 'en' ? "ðŸ‡¬ðŸ‡§" : (@target_lang == 'it' ? "ðŸ‡®ðŸ‡¹" : (@target_lang == 'es' ? "ðŸ‡ªðŸ‡¸" : (@target_lang == 'pt' ? "ðŸ‡µðŸ‡¹" : "ðŸ‡«ðŸ‡·"))) %>
            </span>
            <%= f.select :target_lang, [
              ['FranÃ§ais', 'fr'],
              ['Italiano', 'it'],
              ['English', 'en'],
              ['EspaÃ±ol', 'es'],
              ['PortuguÃªs', 'pt']
            ], { selected: @target_lang }, { onchange: "updateFlag(this, 'target')" } %>
          </div>
        </div>

        <%= f.submit t('search.translate_button', default: 'Translate'), class: "btn-translate-blue" %>
      <% end %>

      <% if @result.present? %>
        <div class="result-display-card">
          <h2 class="result-title">"<%= @idiom %>"</h2>

          <div class="result-content">
            <%= simple_format(@result) %>
          </div>

          <div class="result-actions">
  <% if user_signed_in? %>
    <%= button_to save_translation_path, method: :post, params: {
      original_idiom: @idiom,
      source_language: @source_lang,
      target_language: @target_lang,
      ai_response: @result
    }, class: "btn-save-green" do %>
      <i class="fa-solid fa-bookmark"></i> <%= t('result.save_card', default: 'Save card') %>
    <% end %>
  <% else %>
    <div class="login-invitation">
      <p><%= t('result.want_to_save', default: 'Want to save this idiom?') %></p>
      <%= link_to new_user_registration_path, class: "btn-save-green btn-signup-alt" do %>
        <%= t('result.signup_to_save_button', default: 'Sign up to save') %>
      <% end %>
      <p class="small-login-link">
        <%= t('result.already_have_account', default: 'Already have an account?') %>
        <%= link_to t('nav.login', default: 'Login'), new_user_session_path %>
      </p>
    </div>
  <% end %>
</div>
        </div>
      <% end %>

    </div>
  </div>
</div>

<script>
  function updateFlag(selectElement, type) {
    const flags = {
      'it': 'ðŸ‡®ðŸ‡¹',
      'en': 'ðŸ‡¬ðŸ‡§',
      'fr': 'ðŸ‡«ðŸ‡·',
      'es': 'ðŸ‡ªðŸ‡¸',
      'pt': 'ðŸ‡µðŸ‡¹'
    };

    const selectedValue = selectElement.value;
    const flagSpan = document.getElementById('flag-' + type);

    if (flagSpan && flags[selectedValue]) {
      flagSpan.innerText = flags[selectedValue];
    }
  }

  document.addEventListener("turbo:load", function() {
    const sourceSelect = document.querySelector('select[name="source_lang"]');
    const targetSelect = document.querySelector('select[name="target_lang"]');

    if (sourceSelect) updateFlag(sourceSelect, 'source');
    if (targetSelect) updateFlag(targetSelect, 'target');
  });

  window.onclick = function(event) {
  if (!event.target.closest('.language-dropdown')) {
    var langMenus = document.querySelectorAll('.language-dropdown .dropdown-content');
    langMenus.forEach(function(menu) {
      menu.classList.remove('show');
    });
  }

  if (!event.target.closest('.user-dropdown')) {
    var userMenus = document.querySelectorAll('.user-dropdown .dropdown-content');
    userMenus.forEach(function(menu) {
      menu.classList.remove('show');
    });
  }
}
</script>
